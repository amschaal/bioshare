{% extends "base.html" %}
{% load static %}
{% load share_tags %}
{% load crispy_forms_tags %}
{% load guardian_tags %}
{% block head %}
{{block.super}}
<!-- CSS to style the file input field as button and adjust the Bootstrap progress bars -->
<link rel="stylesheet" href="{{ STATIC_URL }}lib/jquery_upload/css/jquery.fileupload-ui.css">
<link rel="stylesheet" type="text/css" href="{% static "lib/datatables/DT_bootstrap.css" %}">
{% endblock %}

{% block title %}Share: {{share.name}}{% endblock %}

{% block content %}
<h1>
	<a href="{% url 'list_directory' share.id %}" data-toggle="tooltip" title="{{share.notes}}">{{share.name}}</a>
	{% if owner %}<a href="{% url 'delete_share' share.id %}" class="btn btn-danger pull-right margin-3">Delete Share</a>{% endif %}
	{% if "admin" in share_perms %}<a href="{% url 'share_permissions' share.id%}" class="btn btn-warning pull-right margin-3"><i class="fam-user-add"></i> Permissions</a><a href="{% url 'edit_share' share.id %}" class="btn btn-primary pull-right margin-3">Edit</a>{% endif %}
</h1>
{% if subdir %}<h3>{% link_full_path share=share subpath=subdir %}</h3> {% endif %}
<!--  <p>
    {{ path }}
  </p>
  <p>
    {{ share.id }}
  </p>
  <p>
    {{ subdir }}
  </p>
  -->  
  <!-- {{share_perms}} <br>-->
 <ul class="nav nav-tabs" id="page-tabs">
  <li class="active"><a href="#file-tab" data-toggle="tab">Files</a></li>
  <li><a href="#search-tab" data-toggle="tab">Search</a></li>
</ul>
<div class="tab-content">
  <div class="tab-pane active" id="file-tab">
	  {% if "download_share_files" in share_perms %}
	  <div class="btn-group">
		  <a class="btn dropdown-toggle btn-primary" data-toggle="dropdown" href="#">
		    Download
		    <span class="caret"></span>
		  </a>
		  <ul class="dropdown-menu">
		    <li><a href="#" id="download-zip">Zipfile</a></li>
		    <li><a href="#" id="download-rsync">Rsync</a></li>
		  </ul>
	  </div>
	  {% endif %}
	  {% if "write_to_share" in share_perms %}
	  <!-- The fileinput-button span is used to style the file input field as button -->
	    <div class="btn-group">
		  <a class="btn dropdown-toggle btn-success" data-toggle="dropdown" href="#">
		    <i class="icon-plus icon-white"></i>
	        <span>Files</span>
		    <span class="caret"></span>
		  </a>
		  <ul class="dropdown-menu">
		    <li class="fileinput-button"><a href="#"  >Web</a><input id="fileupload" type="file" name="files[]" multiple></li>
		    <li><a href="#" id="upload-rsync">Rsync</a></li>
		  </ul>
	  </div>

	    <a href="#new-folder" role="button" class="btn btn-success" data-toggle="modal"><i class="icon-plus icon-white"></i>Folder</a>
	    {% if "delete_share_files" in share_perms %}
	    <a role="button" class="btn btn-danger" id="delete-button">Delete</a>
	    {% endif %}
	    <br>
	    <!-- The global progress bar -->
	    <div id="progress" class="progress progress-success progress-striped" style="display:none">
	        <div class="bar"></div>
	    </div>
	    <!-- The container for the uploaded files -->
	    <div id="files" class="files"></div>
	  <!-- End file upload -->
	  {% endif %}
	  <div id="messages"></div>
	  <table class="table table-striped table-condensed" id="file-table">
	  <thead><tr><th><input type="checkbox" id="toggle-checkbox"/></th><th>Name</th><th>Tags</th><th style="width:100px;">Size</th><th style="width:150px;">Modified</th><th>Actions</th></tr></thead>
	  <tbody>
	  {% if subdir %}
	 	<tr class="directory"><td></td><td><i class="fam-folder"></i><a href="../">../</a></td><td></td><td></td><td></td><td></td></tr>
	  {% endif %}
	  {% for dir in directories %}
		<tr class="directory real-directory" data-id="{{dir.name}}" data-notes="{{dir.metadata.notes}}" data-tags="{{dir.metadata.tags.all|join:','}}"><td><input class="action-check" type="checkbox"/></td><td class="name" {% if dir.metadata.notes %}data-toggle="tooltip" title="{{dir.metadata.notes}}"{% endif %}><i class="fam-folder"></i><a href="{{dir.name}}">{{ dir.name }}</a></td><td class="tags">{% if dir.metadata.tags %}{% for tag in dir.metadata.tags.all%}{{tag.to_html|safe}}{%endfor%}{% endif %}</td><td></td><td>{{ dir.modified }}</td><td>{% if "write_to_share" in share_perms %}<i data-toggle="tooltip" title="Add/Edit metadata" class="fam-tag-blue" data-action="edit-metadata"></i>{% endif %}{% if "write_to_share" in share_perms %}<i data-toggle="tooltip" title="Modify filename" class="fam-pencil" data-action="modify-name"></i>{% endif%}</td></tr>    
	  {% endfor %}
	  {% for file in files %}
		<tr class="file" data-id="{{file.name}}" data-bytes="{{file.bytes}}" data-notes="{{file.metadata.notes}}" data-tags="{{file.metadata.tags.all|join:','}}"><td><input class="action-check" type="checkbox"/></td><td class="name" {% if file.metadata.notes %}data-toggle="tooltip" title="{{file.metadata.notes}}"{% endif %}><i class="fam-page-white"></i>{% if "download_share_files" in share_perms %}<a href="{% url 'download_file' share=share.id subpath=subdir|default_if_none:""|add:file.name %}">{{ file.name }}</a>{% else %}{{ file.name }}{% endif %}<td class="tags">{% if file.metadata.tags %}{% for tag in file.metadata.tags.all%}{{tag.to_html|safe}}{%endfor%}{% endif %}</td></td><td>{{ file.size }}</td><td>{{ file.modified }}</td><td>{% if "write_to_share" in share_perms %}<i data-toggle="tooltip" title="Add/Edit metadata" class="fam-tag-blue" data-action="edit-metadata"></i>{% endif %} {% if "download_share_files" in share_perms %}{% if file.isText %} <i class="fam-eye" data-toggle="tooltop" title="Preview contents" data-action="preview"></i>{% endif %}{% endif %}{% if "write_to_share" in share_perms %}<i data-toggle="tooltip" title="Modify filename" class="fam-pencil" data-action="modify-name"></i>{% endif%}</td></tr>    
	  {% endfor %}
	  </tbody>
	  </table>
  </div>
  <div class="tab-pane" id="search-tab">
  		<input id="searchBox"><button class="btn" id="searchButton">Search</button>
  		<div id="searchResults">
  		</div>
  </div>
</div>

<div class="modal hide fade" id="new-folder">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3>New Folder</h3>
  </div>
  <div class="modal-body">
    <form class="form-horizontal" method="POST" id="new-folder-form" action="{% if subdir %}{% url 'create_folder' share=share.id subdir=subdir %}{% else %}{% url 'create_folder' share=share.id %}{% endif %}">
	    {{ folder_form|crispy }}
  {% csrf_token %}
  </form>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    <a href="#" class="btn btn-primary" id="create-folder">Create</a>
  </div>
</div>

<div class="modal hide fade" id="modify-name">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3>Rename "<span id="rename-from-label"></span>"</h3>
  </div>
  <div class="modal-body">
    <form class="form-horizontal" method="POST" id="modify-name-form" action="{% if subdir %}{% url 'modify_name' share=share.id subdir=subdir %}{% else %}{% url 'modify_name' share=share.id %}{% endif %}">
	    {{ rename_form|crispy }}
  {% csrf_token %}
  </form>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    <a href="#" class="btn btn-primary" id="rename-button">Rename</a>
  </div>
</div>


<div class="modal hide fade" id="rsync-download">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3>Rsync files</h3>
  </div>
  <div class="modal-body">
    <h3>Download all</h3>
    <b id="rsync-download-all" style="word-wrap: break-word;"></b>
    <h3>Download selected (Linux only)</h3>
    <b id="rsync-download-selected" style="word-wrap: break-word;"></b>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
  </div>
</div>

<div class="modal hide fade" id="rsync-upload">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3>Rsync upload</h3>
  </div>
  <div class="modal-body">
    <b id="rsync-upload-command" style="word-wrap: break-word;"></b>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
  </div>
</div>

<div class="modal hide fade" id="edit-metadata">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3>Metadata for "<span id="metadata-label"></span>"</h3>
  </div>
  <div class="modal-body">
    <input type="hidden" id="metadata-id"/>
    <form class="form-horizontal" method="POST" id="edit-metadata-form">
  	</form>
  	<div id="edit-meta-data-form-clean" class="hidden">{{metadata_form|crispy}}</div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-primary" id="save-metadata" aria-hidden="true">Save</button><button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
  </div>
</div>
<div id="reset-tags" style="
	display:none;
    position: fixed;
    right: 0;
    top: 50%;
    background-color: #999;
    color: white;
    padding: 20px;
    border: 2px solid #555;
    border-radius: 5px;
">
Filtered by: <span id="filtered-tags"></span><br>
<a class="btn btn-primary" id="reset-tag-button">Clear filters</a></div>

{% include "dialogs/preview_file.html" %}
{% endblock %}

{% block scripts %}
{{block.super}}
<!-- The jQuery UI widget factory, can be omitted if jQuery UI is already included -->
<script src="{{STATIC_URL}}lib/jquery_upload/js/vendor/jquery.ui.widget.js"></script>
<!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
<script src="{{STATIC_URL}}lib/jquery_upload/js/jquery.iframe-transport.js"></script>
<!-- The basic File Upload plugin -->
<script src="{{STATIC_URL}}lib/jquery_upload/js/jquery.fileupload.js"></script>
{% include "handlebars/list_files.html" %}
<script>
/*jslint unparam: true */
/*global window, $ */
    {% if subdir %}
    var upload_file_url = '{% url 'upload_file' share=share.id subdir=subdir %}';
    var delete_paths_url = '{% url 'delete_paths' share=share.id subdir=subdir %}';
    var archive_files_url = '{% url 'archive_files' share=share.id subdir=subdir %}';
    var search_url = '{% url 'api_search_share' share=share.id subdir=subdir %}';
    {% else %}
   	var upload_file_url = '{% url 'upload_file' share=share.id %}';
   	var delete_paths_url = '{% url 'delete_paths' share=share.id %}';
   	var archive_files_url = '{% url 'archive_files' share=share.id %}';
   	var search_url = '{% url 'api_search_share' share=share.id %}';
   	{% endif %}
   	var download_file_url = '{% url 'download_file' share=share.id subpath=subdir|default_if_none:""|add:"__file__" %}';
   	var goto_url = '{% url 'go_to_file_or_folder' share='000000000000000' %}';
   	var goto_url_replace = '/000000000000000/';
   	var share_perms = {{share_perms_json|safe}};
   	var share = '{{ share.id }}';
   	var subpath = {% if subdir %}'{{ subdir }}' {% else %} null {% endif %};
   	var metadata_url = '{% url 'api_edit_metadata' share=share.id subpath='' %}' + (subpath ? subpath : '');
	var rsync_url = '{{rsync_url}}';
</script>

<script src="{% static "lib/datatables/jquery.dataTables.min.js" %}"></script>
<script src="{% static "lib/datatables/datatables.filesize.js" %}"></script>
<script src="{% static "lib/datatables/datatables.addtr.js" %}"></script>
<script src="{% static "lib/datatables/datatables.datetimeus.js" %}"></script>
<script src="{% static "lib/datatables/DT_bootstrap.js" %}"></script>

<script>
/* Table initialisation */
$(document).ready(function() {
	filetable = $('#file-table').dataTable( {
		//"sDom": "<'row'<'span6'l><'span6'f>r>t<'row'<'span6'i><'span6'p>>",
		//"sPaginationType": "bootstrap",
		"bPaginate": false,
		"oLanguage": {
			"sLengthMenu": "_MENU_ records per page"
		},
		"aoColumns": [
		                {bSortable: false},
		                null,
		                null,
		                { "sType": "file-size" },
		                { "sType": "datetime-us" },
		                {bSortable: false},
		            ]
	} );
} );
</script>
<script src="{% static "js/share/main.js" %}"></script>
{% endblock%}